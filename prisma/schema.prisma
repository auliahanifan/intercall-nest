// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider     = "prisma-client"
  output       = "../generated/prisma" // `output` is required
  moduleFormat = "cjs" // CommonJS for NestJS compatibility
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id
  name          String
  email         String
  emailVerified Boolean   @default(false)
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @default(now()) @updatedAt
  sessions      Session[]
  accounts      Account[]

  members       Member[]
  invitations   Invitation[]
  userDetail    UserDetail?

  @@unique([email])
  @@map("user")
}

model UserDetail {
  userId                String   @id
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  hasCompletedOnboarding Boolean  @default(false)
  onboardingAnswers     Json?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@map("user_detail")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  activeOrganizationId String?

  @@unique([token])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  @@map("verification")
}

model Organization {
  id             String            @id
  name           String
  slug           String
  logo           String?
  createdAt      DateTime
  metadata       String?
  members        Member[]
  invitations    Invitation[]
  transcriptions Transcription[]
  subscription   OrganizationSubscription?

  @@unique([slug])
  @@map("organization")
}

model Member {
  id             String       @id
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  role           String
  createdAt      DateTime

  @@map("member")
}

model Invitation {
  id             String       @id
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  email          String
  role           String?
  status         String
  expiresAt      DateTime
  inviterId      String
  user           User         @relation(fields: [inviterId], references: [id], onDelete: Cascade)

  @@map("invitation")
}

model Transcription {
  id                   String       @id
  organizationId       String
  durationInMs         BigInt
  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt
  vocabularies         Json?
  modelName            String
  targetLanguage       String
  sourceLanguage       String?
  transcriptionResult  String       @db.Text
  translationResult    String       @db.Text
  version              Int          @default(1)

  organization         Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("transcription")
  @@index([organizationId])
}

model SubscriptionPlan {
  id                   String                      @id @default(cuid())
  name                 String
  slug                 String                      @unique
  description          String?
  price                Int                         @default(0)
  normalPrice          Int                         @default(0)
  promoPrice           Int?
  isPromo              Boolean                     @default(false)
  paymentLink          String?
  currency             String                      @default("USD")
  quotaMinutes         Int
  quotaResetsMonthly   Boolean                     @default(false)
  features             Json?
  isActive             Boolean                     @default(true)
  createdAt            DateTime                    @default(now())
  updatedAt            DateTime                    @updatedAt
  subscriptions        OrganizationSubscription[]

  @@map("subscription_plan")
  @@index([slug])
}

model OrganizationSubscription {
  id                    String            @id @default(cuid())
  organizationId        String            @unique
  organization          Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  planId                String
  plan                  SubscriptionPlan  @relation(fields: [planId], references: [id])
  status                String            @default("active")
  currentPeriodStart    DateTime          @default(now())
  currentPeriodEnd      DateTime?
  lifetimeUsageMinutes  Float             @default(0)
  stripeSubscriptionId  String?           @unique
  stripeCustomerId      String?
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  canceledAt            DateTime?
  usagePeriods          UsagePeriod[]

  @@map("organization_subscription")
  @@index([organizationId])
  @@index([planId])
}

model UsagePeriod {
  id              String                   @id @default(cuid())
  subscriptionId  String
  subscription    OrganizationSubscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  periodStart     DateTime
  periodEnd       DateTime
  usageMinutes    Float                    @default(0)
  createdAt       DateTime                 @default(now())
  updatedAt       DateTime                 @updatedAt

  @@map("usage_period")
  @@index([subscriptionId, periodStart])
  @@unique([subscriptionId, periodStart])
}
